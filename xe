#!/bin/bash
# Use xe.com to convert currency on the commandline
#
# Idea stolen from 
# http://www.commandlinefu.com/commands/view/7866/currency-converter-using-xe.com
# by gammy

for dep in curl bc sed; do
	which $dep > /dev/null || exit $?
done

if [ $# -ne 3 ]; then
	echo "Usage: xe <amount> <source currency> <target currency>"
	echo "Example: xe 100+50 usd gbp"
	exit 1
fi

amount=$(echo "$1" | bc -l)

from="${2::3}" # Truncate to 3 chars
  to="${3::3}" 

args="Amount=${amount}&From=${from}&To=${to}"
cmd=(curl "http://www.xe.com/wap/2co/convert.cgi?${args}" -A Mozilla -s)

html=$(${cmd[@]})

code="$?"
text=$(echo $html | sed -n "s/.*>\(.*\) ${to^^}<.*/\1/p") # Magic

if [ "$code" != "0" -o "$text" == "ERR" -o -z "$text" ]; then
	dump=$(mktemp)
	echo -e "'${cmd[@]}' ($code) \"$text\":\n$html" > "$dump"
	echo "It appears that conversion failed, see \"$dump\" for details" >&2
	exit 1
fi

echo "$amount $from = $text $to"
